---
title: "Anova and Chi-sq test of independence"
author: "Harsha Achyuthuni"
date: "July 16 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(tidyverse)
set.seed(0512)
setwd('C:\\Users\\Achyuthuni\\Desktop\\attendance')
travel <- read_csv("travel.csv")
```

In this post, I would like to look into AnOVa and Chi-sq test of independance. From the attendance data set, I would like to understand if there is any significant difference in my travelling time to office when I use diffeent types of transportation.  

As I want to test that there is significant difference between travelling time when I use different types of transport, the null and alternate hypothesis will be as follows:  
H0: μvehicle = μwalking = μcycling  
H1: Not all μ are equal

Sample attendance data set (necessary columns only) are: 
```{r activities4, echo=FALSE}
dplyr::sample_n(travel %>% dplyr::select(date, main_activity, travelling.time), 5)
travel$travelling.time <- as.numeric(travel$travelling.time)
```

Plotting the frequencies of different types of transportation. This is the number of times I have used that particular transport to travel to office.  

```{r activities5, echo=FALSE}
ggplot(travel, aes(x = main_activity, group = main_activity, fill = main_activity)) + 
  geom_bar()  + 
  guides(fill = FALSE) +
  theme_minimal() +
  labs(
    x = "",
    y = "Count",
    title = "Type of transport"
  )
```

The summary statistics of travelling time for different types of transportation are as follows:  
```{r summary_stats, echo=TRUE}
data.summary <- travel %>% 
  rename(group = main_activity) %>% 
  group_by(group) %>% 
  summarise(count = n(), 
            mean = mean(travelling.time),
            sd = sd(travelling.time))
data.summary
```

One of the conditions to do anova is that the population response variable follows a normal distribution in each group. The distribution of travelling time with different types of transport are as follows:

```{r real_plots, echo=TRUE}
ggplot() + 
  geom_density(data=travel, aes(x=travelling.time, group=main_activity, color=main_activity), adjust=2) +
  labs(x = 'Travelling time(sec)', y='Density',  title = 'Testing normality among response variables') +
  theme_minimal()+theme(legend.position="bottom")
```

From the above graph, it looks like the three groups are normally distributed. To test for normality, we could use chi-square test.  
The chi-square goodness of fit test for each group would have the following hypothesis:  
H0: The transportation.time in the group is normally distributed  
H1: The transportation.time in the group is not normally distributed 
```{r chi-sq-test-function-creation, echo=TRUE}
# Functions used in chi-sq-test

chi.sq.plot <- function(pop.mean=0, alpha = 0.05, chi.sq, df,
                              label = 'Chi Square distribution',title = 'Chi Square goodness of fit test'){
  # Creating a sample chi-sq distribution
  range <- seq(qchisq(0.0001, df), qchisq(0.9999, df), by = (qchisq(0.9999, df)-qchisq(0.0001, df))*0.001)
  chi.sq.dist <- data.frame(range = range, dist = dchisq(x = range, ncp = pop.mean, df = df)) %>% 
    dplyr::mutate(H0 = if_else(range <= qchisq(p = 1-alpha, ncp = pop.mean, df = df,lower.tail = TRUE),'Retain', 'Reject'))
  # Plotting sampling distribution and x_bar value with cutoff
  plot.test <- ggplot(data = chi.sq.dist, aes(x = range,y = dist)) +
    geom_area(aes(fill = H0)) +
    scale_color_manual(drop = TRUE, values = c('Retain' = "#00BFC4", 'Reject' = "#F8766D"), aesthetics = 'fill') +
    geom_vline(xintercept = chi.sq, size = 2) +
    geom_text(aes(x = chi.sq, label = paste0('Chi Sq = ', round(chi.sq,3)), y = mean(dist)), colour="blue", vjust = 1.2) +
    labs(x = label, y='Density',  title = title) +
    theme_minimal()+theme(legend.position="bottom")
  plot(plot.test)
}
```

```{r chi-sq, echo=TRUE}
for(i in 1:nrow(data.summary)){
  mean <- data.summary$mean[i]
  sd <- data.summary$sd[i]
  length <- data.summary$count[i]
  range <- seq(mean-3*sd, mean+3*sd, by = sd*0.001)
  norm.dist <- rnorm(n = length, mean = mean, sd = sd)
  test.dist <- (travel %>% dplyr::filter(main_activity == data.summary$group[i]))$travelling.time
  cat('Testing for group ', data.summary$group[i], '\n')
  chi.test <- chisq.test(norm.dist, test.dist)
  print(chi.test)
  chi.sq.plot(chi.sq = chi.test$statistic, df = chi.test$parameter, title = data.summary$group[i])
}
```
As p > α, where α = 0.05, retaining the Null hypothesis in all the three groups. Therefore we can assume that travelling.time is normally distributed among all groups.  

Another condition for anova is that the population variances are assumed to be same. This is an assumption I am willing to take at this point.  

Taking these assumptions, the ideal distributions of the sample are as follows. These distributions can be compared to a [simulation](https://harshaash.shinyapps.io/AnovaSimulation/) that I created where change in F value (and significance of anova) can be visualised by increasing the between variance (increasing the distance between group means)  

```{r normal_plots, echo=TRUE}
plot.normal.groups <- function(data.summary, mean, sd, label, title){
  common.group.sd <- mean(data.summary$sd)

  range <- seq(mean-3*sd, mean+3*sd, by = sd*0.001)
  norm.dist <- data.frame(range = range, dist = dnorm(x = range, mean = mean, sd = sd))
  # Plotting sampling distribution and x_bar value with cutoff
  norm.aov.plot <- ggplot(data = norm.dist, aes(x = range,y = dist))
  for (i in 1:nrow(data.summary)) {
    norm.aov.plot <- norm.aov.plot + 
      stat_function(fun = dnorm, color=colors()[sample(50:100, 1)],  size = 1, 
                    args = list(mean = data.summary$mean[i], sd = common.group.sd))
  }
  norm.aov.plot + labs(x = label, y='Density',  title = title) +
      theme_minimal()+theme(legend.position="bottom")
}



set.seed(9)
mean <- mean(travel$travelling.time)
sd <- sd(travel$travelling.time)
plot.normal.groups(data.summary, mean, sd, 'Travel time (sec)', 'Assuming normality among response variables')
```

Performing Anova with 
H0: μvehicle = μwalking = μcycling
H1: Not all μ are equal

```{r anova-test-function-creation, echo=TRUE}
# Functions used in anova-test

f.plot <- function(pop.mean=0, alpha = 0.05, f, df1, df2,
                              label = 'F distribution',title = 'Anova test'){
  # Creating a sample F distribution
  range <- seq(qf(0.0001, df1, df2), qf(0.9999, df1, df2), by = (qf(0.9999, df1, df2)-qf(0.0001, df1, df2))*0.001)
  f.dist <- data.frame(range = range, dist = df(x = range, ncp = pop.mean, df1 = df1, df2 = df2)) %>% 
    dplyr::mutate(H0 = if_else(range <= qf(p = 1-alpha, ncp = pop.mean, df1 = df1,df2 = df2),'Retain', 'Reject'))
  # Plotting sampling distribution and F value with cutoff
  plot.test <- ggplot(data = f.dist, aes(x = range,y = dist)) +
    geom_area(aes(fill = H0)) +
    scale_color_manual(drop = TRUE, values = c('Retain' = "#00BFC4", 'Reject' = "#F8766D"), aesthetics = 'fill') +
    geom_vline(xintercept = f, size = 2) +
    geom_text(aes(x = f, label = paste0('F = ', round(f,3)), y = mean(dist)), colour="blue", vjust = 1.2) +
    labs(x = label, y='Density',  title = title) +
    theme_minimal()+theme(legend.position="bottom")
  plot(plot.test)
}
```

```{r anova, echo=TRUE}
anva <- aov(travelling.time ~ main_activity, travel)
anova.summary <- summary(anva)
print(anova.summary)
f.plot(f = anova.summary[[1]]$F[1], df1 = anova.summary[[1]]$Df[1], df2 = anova.summary[[1]]$Df[2])
```

As p < α, where α = 0.05. Hence rejecting the Null Hypothesis. From this test we can observe that not all groups have same mean. But to find out which groups are similar and which are different, I am conducting a TukeyHSD test.  
```{r tukeyHSD, echo=TRUE}
TukeyHSD(anva)
```

From this test we can see that there is significant difference (with α = 0.05 confidence) between travelling by vehicle when compared to travelling by walk or cycle.  

Created on 17th June 2019, Achyuthuni Sri Harsha